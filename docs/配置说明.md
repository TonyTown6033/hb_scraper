# 配置说明文档

## 概述

本项目已将所有输入输出参数提取到配置文件中，方便用户自定义和管理。配置系统包含以下文件：

- `config.py` - 配置管理模块，定义所有配置项和默认值
- `.env` - 用户自定义配置文件（需要用户创建）
- `.env.example` - 配置文件示例模板

## 快速开始

### 1. 创建配置文件

```bash
# 复制示例配置文件
cp .env.example .env

# 编辑配置文件
vim .env  # 或使用其他编辑器
```

### 2. 修改配置

打开 `.env` 文件，根据需要修改配置项。如果不修改，将使用默认值。

### 3. 运行程序

配置文件会自动加载，无需额外操作：

```bash
# 运行主程序
uv run python main.py

# 运行多页爬虫脚本
uv run python scripts/scrape_multi_pages.py
```

## 配置项详解

### 图床配置

```bash
IMAGE_API_URL=http://81.68.170.234/api/index.php  # 图床API地址
IMAGE_API_TOKEN=your_token_here                    # 图床API Token
IMAGE_TARGET_WIDTH=800                             # 目标图片宽度（像素）
IMAGE_TARGET_HEIGHT=400                            # 目标图片高度（像素）
```

### OpenAI 配置

```bash
OPENAI_API_KEY=your_key_here                      # OpenAI API密钥（用于翻译）
OPENAI_BASE_URL=https://api.openai.com/v1        # OpenAI API基础URL
```

### 爬虫URL配置

```bash
# 默认爬取的分类URL，可修改为其他分类
SCRAPER_CATEGORY_URL=https://www.hollandandbarrett.com/shop/vitamins-supplements/condition/hair-skin-nails/
```

**其他可用分类示例：**
- `https://www.hollandandbarrett.com/shop/vitamins-supplements/condition/immune-support/`
- `https://www.hollandandbarrett.com/shop/vitamins-supplements/vitamins/vitamin-d/`
- 等等...

### 输出文件配置

```bash
OUTPUT_BASIC_FILE=products_basic.csv              # 基本信息输出文件名
OUTPUT_COMPLETE_FILE=products_complete.csv        # 完整信息输出文件名
OUTPUT_FAILED_FILE=failed_products.json           # 失败产品记录文件名
```

所有输出文件都保存在 `data/output/` 目录下。

### Chrome浏览器配置

```bash
# 浏览器User-Agent（可自定义）
CHROME_USER_AGENT=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36...

# 是否启用headless模式
# true = 无界面运行（服务器推荐）
# false = 显示浏览器窗口（本地调试推荐）
CHROME_HEADLESS=true

# 页面加载策略
# normal = 等待所有资源加载完成
# eager = 不等待图片、样式表等资源（推荐，更快）
# none = 不等待页面加载
CHROME_PAGE_LOAD_STRATEGY=eager
```

### 爬虫行为配置

```bash
PAGE_LOAD_TIMEOUT=60    # 页面加载超时（秒）
SCRIPT_TIMEOUT=60       # 脚本执行超时（秒）
PAGE_WAIT_TIME=3        # 页面等待时间（秒）
COOKIE_TIMEOUT=5        # Cookie弹窗处理超时（秒）
```

### 并行爬取配置

```bash
PARALLEL_MAX_WORKERS=3     # 默认并发线程数（建议3-5）
MAX_WORKERS_LIMIT=10       # 最大并发线程数限制
RETRY_TIMES=3              # 失败重试次数
REQUEST_DELAY_MIN=2        # 请求间隔最小值（秒）
REQUEST_DELAY_MAX=4        # 请求间隔最大值（秒）
BATCH_SIZE=100             # 批次写入大小（每N个产品写入一次）
```

**性能调优建议：**
- 本地环境：`PARALLEL_MAX_WORKERS=3-5`
- 服务器环境：`PARALLEL_MAX_WORKERS=5-8`
- 网络不稳定：减少 `MAX_WORKERS`，增加 `REQUEST_DELAY`
- 需要快速爬取：增加 `MAX_WORKERS`，减少 `REQUEST_DELAY`（注意可能被封）

### 多页爬取配置

```bash
# 是否启用断点续传
# true = 中断后可继续爬取
# false = 每次重新开始
ENABLE_RESUME=true

# 断点续传时是否自动继续（仅在INTERACTIVE_MODE=false时生效）
# true = 自动从上次中断处继续
# false = 重新开始爬取
AUTO_RESUME=true
```

### 非交互式模式配置 ⭐ 新功能

本项目现在支持**完全非交互式运行**，所有交互式选项都可以通过配置文件预先设置。

```bash
# 是否启用交互式模式
# true = 运行时会提示用户输入选择
# false = 完全自动运行，使用配置文件中的设置
INTERACTIVE_MODE=true
```

#### 爬取模式配置

```bash
# 爬取模式（仅在INTERACTIVE_MODE=false时生效）
# 1 = 单页模式（仅爬取第一页，快速测试）
# 2 = 多页模式（爬取所有页面，完整数据）
# 3 = 限制页数模式（爬取指定页数）
SCRAPE_MODE=1

# 限制页数（当SCRAPE_MODE=3时使用）
MAX_PAGES_LIMIT=5
```

#### 详情页爬取配置

```bash
# 是否爬取详情页
# true = 爬取产品详情信息（耗时较长）
# false = 仅爬取列表页基本信息（快速）
SCRAPE_DETAILS=false

# 爬取详情页的最大产品数量
# 留空 = 爬取全部产品
# 设置数字 = 只爬取指定数量的产品
MAX_PRODUCTS_TO_SCRAPE=

# 详情页爬取模式（仅在SCRAPE_DETAILS=true时生效）
# 1 = 顺序模式（一个接一个爬取，较慢但稳定）
# 2 = 并行模式（多线程同时爬取，推荐）
DETAIL_SCRAPE_MODE=2
```

#### 后处理配置

```bash
# 是否运行翻译功能
RUN_TRANSLATION=true

# 是否运行图片处理功能
RUN_IMAGE_PROCESSING=true
```

## 在代码中使用配置

### 导入配置

```python
import config
```

### 使用配置项

```python
# 直接访问配置常量
url = config.DEFAULT_CATEGORY_URL
timeout = config.PAGE_LOAD_TIMEOUT
workers = config.DEFAULT_MAX_WORKERS

# 使用辅助函数
chrome_options = config.get_chrome_options()
output_file = config.get_output_path(output_type='basic')
product_type = config.get_product_type_from_url(url)
```

## 配置优先级

1. **环境变量** - 最高优先级（.env 文件中定义的值）
2. **默认值** - 在 `config.py` 中定义的默认值

示例：
```python
# config.py 中的定义
PAGE_LOAD_TIMEOUT = int(os.getenv('PAGE_LOAD_TIMEOUT', '60'))
```

- 如果 `.env` 中设置了 `PAGE_LOAD_TIMEOUT=30`，则使用 30
- 如果 `.env` 中未设置，则使用默认值 60

## 常见配置场景

### 场景1: 本地开发和调试（交互式）

```bash
# .env
INTERACTIVE_MODE=true              # 启用交互式模式
CHROME_HEADLESS=false              # 显示浏览器窗口，方便调试
PARALLEL_MAX_WORKERS=2             # 减少并发，方便观察
REQUEST_DELAY_MIN=3                # 增加延迟，避免被封
REQUEST_DELAY_MAX=5
```

### 场景1.5: 非交互式快速测试 ⭐ 推荐

```bash
# .env - 自动运行，无需输入
INTERACTIVE_MODE=false             # 关闭交互式模式
SCRAPE_MODE=1                      # 单页模式
SCRAPE_DETAILS=false               # 不爬取详情页
CHROME_HEADLESS=true               # 无界面运行
RUN_TRANSLATION=false              # 跳过翻译
RUN_IMAGE_PROCESSING=false         # 跳过图片处理
```

运行后完全自动执行，适合快速测试或定时任务。

### 场景2: 服务器批量爬取（非交互式） ⭐ 推荐

```bash
# .env - 完整爬取所有页面和详情
INTERACTIVE_MODE=false             # 关闭交互式，自动运行
SCRAPE_MODE=2                      # 多页模式，爬取所有页面
SCRAPE_DETAILS=true                # 爬取详情页
MAX_PRODUCTS_TO_SCRAPE=            # 留空，爬取全部产品
DETAIL_SCRAPE_MODE=2               # 并行模式
CHROME_HEADLESS=true               # 无界面运行
PARALLEL_MAX_WORKERS=5             # 提高并发
REQUEST_DELAY_MIN=2                # 适中的延迟
REQUEST_DELAY_MAX=4
BATCH_SIZE=100                     # 大批次写入，提高效率
RUN_TRANSLATION=true               # 运行翻译
RUN_IMAGE_PROCESSING=true          # 运行图片处理
```

完全自动化，适合服务器定时任务或批量爬取。

### 场景3: 爬取不同分类（非交互式限制页数）

```bash
# .env - 爬取指定分类的前5页，包含详情
INTERACTIVE_MODE=false
SCRAPER_CATEGORY_URL=https://www.hollandandbarrett.com/shop/vitamins-supplements/vitamins/vitamin-d/
SCRAPE_MODE=3                      # 限制页数模式
MAX_PAGES_LIMIT=5                  # 爬取5页
SCRAPE_DETAILS=true                # 爬取详情
MAX_PRODUCTS_TO_SCRAPE=50          # 只爬取前50个产品的详情
OUTPUT_BASIC_FILE=vitamin_d_basic.csv
OUTPUT_COMPLETE_FILE=vitamin_d_complete.csv
CHROME_HEADLESS=true
```

### 场景4: 网络不稳定环境

```bash
# .env
PAGE_LOAD_TIMEOUT=120              # 增加超时时间
RETRY_TIMES=5                      # 增加重试次数
PARALLEL_MAX_WORKERS=2             # 减少并发
REQUEST_DELAY_MIN=4                # 增加延迟
REQUEST_DELAY_MAX=6
```

## 配置文件管理最佳实践

1. **不要提交 .env 文件到Git**
   - `.env` 文件已在 `.gitignore` 中
   - 只提交 `.env.example` 作为模板

2. **使用环境变量覆盖**
   ```bash
   # 临时修改配置运行
   PARALLEL_MAX_WORKERS=10 uv run python main.py
   ```

3. **多环境配置**
   ```bash
   # 创建不同环境的配置文件
   .env.development
   .env.production

   # 使用时复制到 .env
   cp .env.production .env
   ```

4. **配置验证**
   ```python
   # 在代码中验证配置
   import config

   print(f"当前爬取URL: {config.DEFAULT_CATEGORY_URL}")
   print(f"并发线程数: {config.DEFAULT_MAX_WORKERS}")
   print(f"输出目录: {config.OUTPUT_DIR}")
   ```

## 故障排查

### 问题：配置未生效

**解决方案：**
1. 确认 `.env` 文件在项目根目录
2. 检查配置项名称是否正确（区分大小写）
3. 重启程序以加载新配置

### 问题：找不到输出文件

**解决方案：**
1. 检查 `OUTPUT_DIR` 配置
2. 确认程序有写入权限
3. 查看日志中的完整路径

### 问题：Chrome浏览器启动失败

**解决方案：**
1. 在本地环境设置 `CHROME_HEADLESS=false` 查看错误
2. 检查是否安装了Chrome/Chromium
3. 在服务器环境确保设置了 `--no-sandbox` 选项（已默认启用）

## 总结

通过配置文件系统，你可以：
- ✅ 轻松修改爬虫目标URL
- ✅ 自定义输出文件路径和名称
- ✅ 调整浏览器行为和性能参数
- ✅ 配置并行爬取策略
- ✅ 适应不同的运行环境

配置文件使项目更加灵活和易于维护，无需修改代码即可调整行为。
