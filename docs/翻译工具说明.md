# 翻译工具使用说明

## 功能

自动将爬取的产品信息翻译成中文（或其他语言）。

## 已修复的问题

### 1. ❌ 原问题
- API Key 硬编码在代码中（安全风险）
- 翻译所有列（包括URL、价格等不需要翻译的字段）
- 没有进度显示
- 没有错误重试机制
- 客户端初始化在模块级别，导致导入即报错

### 2. ✅ 修复内容
- 支持从环境变量读取 API Key
- 只翻译需要的列（产品名称、亮点、描述等）
- 添加进度显示和详细日志（使用 tqdm 进度条）
- 添加错误重试机制（最多3次）
- 客户端延迟初始化
- 添加文件存在检查
- **多线程并发翻译（最多5个并发线程）**
- **线程安全的速率限制机制**
- **自动过滤地址信息**（删除街道地址、邮编等）
- 优化翻译速度控制

## 使用方法

### 1. 基本使用

```bash
# 运行翻译脚本
uv run python translate.py
```

### 2. 使用环境变量（推荐）

```bash
# 设置 API Key
export OPENAI_API_KEY="your-api-key"
export OPENAI_BASE_URL="https://api.openai-proxy.org/v1"

# 运行翻译
uv run python translate.py
```

### 3. 配置文件

在 `translate.py` 中修改配置：

```python
# 需要翻译的列
COLUMNS_TO_TRANSLATE = [
    "产品名称",
    "产品亮点",
    "产品描述",
    "用法服量",
    "营养成分",
    "配料表"
]

# 输入输出文件
INPUT_CSV = "./data/output/products_complete.csv"
OUTPUT_CSV = "./data/output/products_complete_zh.csv"
```

## 翻译流程

```
1. 检查输入文件是否存在
   ↓
2. 初始化 OpenAI 客户端
   ↓
3. 读取 CSV 文件
   ↓
4. 显示需要翻译的列和预计时间
   ↓
5. 询问用户确认
   ↓
6. 多线程并发翻译（带 tqdm 进度条）
   ├─ 线程1: 翻译单元格
   ├─ 线程2: 翻译单元格
   ├─ 线程3: 翻译单元格
   ├─ 线程4: 翻译单元格
   └─ 线程5: 翻译单元格
   ↓
7. 保存翻译结果
```

## 输出示例

```
🔧 初始化 OpenAI 客户端...
   Base URL: https://api.openai-proxy.org/v1
✓ 客户端初始化成功

📖 读取文件：./data/output/products_complete.csv
✓ 共 20 行数据，12 列

🔄 需要翻译的列：产品名称, 产品亮点, 产品描述, 用法服量, 营养成分, 配料表
⏭️  跳过的列：产品价格, 产品品牌, 产品图, 产品类型, 作用部位, URL

⚙️  多线程配置：
   最大并发线程数: 5
   速率限制延迟: 0.2秒

⏱️  预计耗时：
   单线程: 240秒 (4.0分钟)
   多线程: 48秒 (0.8分钟)

是否开始翻译？(y/n): y

🚀 开始多线程翻译...
   总任务数: 120
   并发线程: 5
============================================================

翻译进度: 100%|████████████████████| 120/120 [00:48<00:00,  2.5cell/s]

============================================================
✓ 翻译完成
   成功: 120 个
   失败: 0 个
============================================================

============================================================
💾 保存翻译结果...
✅ 翻译完成！文件已保存为: ./data/output/products_complete_zh.csv
============================================================
```

## 费用估算

使用 `gpt-4o-mini` 模型：
- 输入：$0.15 / 1M tokens
- 输出：$0.60 / 1M tokens

假设 20 个产品，6 个字段：
- 每个字段平均 100 字符 ≈ 25 tokens
- 总计：20 × 6 × 25 × 2 (输入+输出) = 6,000 tokens
- 费用：约 $0.005（不到1分钱）

## 注意事项

### 1. API Key 安全
⚠️ **不要将 API Key 提交到 Git！**

```bash
# 添加到 .gitignore
echo "*.env" >> .gitignore
```

### 2. 翻译质量
- 使用 `gpt-4o-mini` 性价比高
- 如需更高质量，可改用 `gpt-4o`
- 翻译会保持原有格式（如分号分隔）
- **自动过滤地址**：翻译时会自动删除街道地址、邮编、城市、国家等信息

### 3. 速度控制和并发
- **多线程并发**：默认5个线程同时翻译
- **速率限制**：每个请求间隔 0.2 秒（使用线程锁控制）
- **避免限流**：通过速率限制和并发控制平衡速度和稳定性
- **自动重试**：失败时自动重试（最多3次）
- **可调参数**：
  - `MAX_WORKERS`：并发线程数（建议5-10）
  - `RATE_LIMIT_DELAY`：请求间隔（秒）

### 4. 错误处理
- 翻译失败时保留原文
- 自动跳过空值
- 自动跳过过短文本（<3字符）

## 常见问题

### Q: 如何只翻译部分产品？

修改 CSV 文件，只保留需要翻译的行。

### Q: 如何修改翻译的目标语言？

在 `translate_text()` 函数中修改 `target_lang` 参数。

### Q: 翻译速度太慢？

1. **增加并发线程数**：修改 `MAX_WORKERS` 为更大值（如10），但注意API限流
2. **减少延迟时间**：降低 `RATE_LIMIT_DELAY`（如0.1秒），但可能被限流
3. **减少需要翻译的列**：在 `COLUMNS_TO_TRANSLATE` 中只保留必要列
4. **使用更快的模型**：切换到 `gpt-3.5-turbo`（质量略低但更快）

当前默认配置（5线程，0.2秒延迟）已经是较优平衡，速度提升约5倍。

### Q: 如何控制地址过滤？

翻译脚本默认会自动删除所有地址信息（街道、邮编、城市、国家等）。这是通过 GPT 的系统提示词实现的。

如果你想保留地址，可以修改 `translate.py` 中的系统提示词：

```python
"content": "你是一个专业的翻译助手。翻译规则：\n1. 只翻译产品信息，不解释、不增删\n2. 保持原有的格式（如分号分隔、换行等）",
```

### Q: API 报错怎么办？

1. 检查 API Key 是否正确
2. 检查网络连接
3. 检查代理设置
4. 查看错误信息

## 高级用法

### 批量翻译多个文件

```bash
# 创建批量脚本
for file in data/output/products_*.csv; do
    INPUT_CSV=$file OUTPUT_CSV=${file%%.csv}_zh.csv uv run python translate.py
done
```

### 使用不同的模型

修改 `translate.py` 中的模型：

```python
model="gpt-4o"  # 更高质量
model="gpt-3.5-turbo"  # 更便宜
```

## 依赖

- `openai` - OpenAI API 客户端
- `pandas` - CSV 处理
- `tqdm` - 进度条显示
- `httpx[socks]` - SOCKS 代理支持（可选）

安装：
```bash
uv add openai pandas tqdm "httpx[socks]"
```

## 相关文件

- `translate.py` - 翻译脚本
- `data/output/products_complete.csv` - 输入文件
- `data/output/products_complete_zh.csv` - 输出文件
